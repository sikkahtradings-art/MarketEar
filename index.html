<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>MarketEar Pro | Eyes-Free Audio Trading</title>

  <!-- Manifest for PWA (no edits needed if placed at /MarketEar/manifest.json) -->
  <link rel="manifest" href="/MarketEar/manifest.json">
  <meta name="theme-color" content="#fcd34d">

  <!-- Tailwind CDN (ok for testing) -->
  <script src="https://cdn.tailwindcss.com"></script>
  <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;600;700;800;900&display=swap" rel="stylesheet">

  <style>
    body { font-family: 'Inter', sans-serif; background:#1a1e23; color:#e2e8f0; }
    .market-card { background:#242930; border:1px solid #30363d; box-shadow:0 4px 6px rgba(0,0,0,0.2); }
    .accent-yellow{ color:#fcd34d; } .bg-accent-yellow{ background:#fcd34d; }
    .slider{ background:#4b5563; transition:.4s; }
    .slider:before{ content:""; position:absolute; height:1rem; width:1rem; left:0.25rem; bottom:0.25rem; background:#fff; transition:.4s; border-radius:9999px; }
    #__marketEarTestBtn_visible { position:fixed; bottom:16px; left:16px; z-index:99999; padding:12px 14px; background:#10b981; color:white; font-weight:800; border-radius:10px; box-shadow:0 8px 20px rgba(0,0,0,.25); }
    #__marketEarAllowModal { position:fixed; inset:0; display:flex; align-items:center; justify-content:center; z-index:99998; }
    #__marketEarAllowBox { background:#0b1220; border:1px solid #2a2f36; padding:20px; border-radius:12px; box-shadow:0 12px 40px rgba(0,0,0,.6); color:#e6eef8; max-width:420px; text-align:center; }
  </style>
</head>
<body class="flex flex-col min-h-screen">

  <!-- Header -->
  <header class="bg-gray-900 border-b border-gray-700 sticky top-0 z-50">
    <div class="max-w-7xl mx-auto px-4 py-4 flex justify-between items-center">
      <div class="flex items-center">
        <div class="bg-yellow-400 p-2 rounded-lg mr-3 shadow-lg border border-yellow-200">
          <svg viewBox="0 0 45 28" class="w-12 h-8"><text x="-2" y="25" font-size="36" font-weight="900" fill="#10b981">M</text><text x="23" y="25" font-size="36" font-weight="900" fill="#f43f5e">E</text></svg>
        </div>
        <div>
          <h1 class="text-2xl font-extrabold text-white">MarketEar Pro</h1>
          <p class="text-sm text-gray-400">Eyes-free audio price announcement engine</p>
        </div>
      </div>

      <div class="flex items-center space-x-4">
        <div id="status-badge" class="px-4 py-2 rounded-xl text-sm font-semibold bg-gray-700 flex items-center">
          <span id="status-dot" class="w-3 h-3 rounded-full bg-yellow-400 mr-3 animate-pulse"></span>
          <div class="flex flex-col">
            <span id="status-text" class="text-white font-bold">Initializing...</span>
            <span id="frequency-text" class="text-xs text-gray-400">--</span>
            <span id="countdown-text" class="text-xs hidden"></span>
          </div>
        </div>

        <button id="toggle-btn" aria-label="Start or stop audio announcements" class="bg-accent-yellow text-gray-900 px-6 py-2 rounded-xl font-bold disabled:opacity-50" disabled>
          Loading Voice...
        </button>
      </div>
    </div>
  </header>

  <!-- Main -->
  <main class="flex-grow max-w-7xl mx-auto px-4 py-8 w-full">
    <section class="mb-6">
      <h2 class="text-xl font-bold text-white">Active Portfolio</h2>
      <p class="text-gray-400 text-sm">Toggle which assets are announced. Prices update live.</p>
    </section>

    <section id="assets-grid" class="grid grid-cols-1 md:grid-cols-3 gap-6 mb-8">
      <!-- cards injected by JS -->
    </section>

    <section class="bg-gray-800 market-card rounded-xl p-6">
      <h3 class="text-lg font-semibold text-white mb-4">Audio & Content Settings</h3>
      <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
        <div>
          <label class="text-sm text-gray-300">Update Frequency</label>
          <select id="interval-select" class="w-full bg-gray-700 border border-gray-600 text-white rounded p-2">
            <option value="15000">15 Seconds</option>
            <option value="30000" selected>30 Seconds</option>
            <option value="60000">1 Minute</option>
            <option value="120000">2 Minutes</option>
          </select>
        </div>
        <div>
          <label class="text-sm text-gray-300">Voice</label>
          <select id="voice-select" class="w-full bg-gray-700 border border-gray-600 text-white rounded p-2">
            <option value="default" selected>Default</option>
          </select>
        </div>

        <div>
          <label class="flex items-center justify-between text-sm text-gray-300">
            <span>Full Price Precision</span>
            <input id="full-precision" type="checkbox" class="ml-2">
          </label>
        </div>

        <div>
          <label class="flex items-center justify-between text-sm text-gray-300">
            <span>Price Only (Brief)</span>
            <input id="brief-mode" type="checkbox" checked class="ml-2">
          </label>
        </div>
      </div>
    </section>
  </main>

  <footer class="bg-gray-900 text-gray-500 py-4 text-center text-xs border-t border-gray-800">
    <p>MarketEar Pro | For informational purposes only.</p>
  </footer>

  <!-- Allow-audio onboarding modal (hidden after user accepts) -->
  <div id="__marketEarAllowModal" style="display:none">
    <div id="__marketEarAllowBox">
      <h3 style="font-weight:800;margin-bottom:8px">Allow Audio</h3>
      <p style="color:#b9c6d6;margin-bottom:12px">Click the button below so your browser allows MarketEar to speak price announcements. This is required only once.</p>
      <button id="__marketEarAllowBtn" style="background:#facc15;color:#111;padding:10px 14px;border-radius:8px;font-weight:700">▶ Enable Audio</button>
    </div>
  </div>

  <!-- MarketEar main script (global STATE, UI, TTS) -->
  <script>
  // Make STATE global so console & bridge can access it
  window.STATE = window.STATE || {
    isRunning: false,
    voiceReady: false,
    intervalMs: 30000,
    briefMode: true,
    fullPrecision: false,
    voiceGender: 'female',
    timers: { audio: null },
    remainingTime: 0
  };

  (function(){
    const els = {
      grid: document.getElementById('assets-grid'),
      toggleBtn: document.getElementById('toggle-btn'),
      statusText: document.getElementById('status-text'),
      statusDot: document.getElementById('status-dot'),
      frequencyText: document.getElementById('frequency-text'),
      countdownText: document.getElementById('countdown-text'),
      intervalSelect: document.getElementById('interval-select'),
      voiceSelect: document.getElementById('voice-select'),
      briefMode: document.getElementById('brief-mode'),
      fullPrecision: document.getElementById('full-precision')
    };

    // If bridge not present yet, create default assets so UI renders immediately
    if (!window.assets || !Array.isArray(window.assets)) {
      window.assets = [
        { id: 'btcusd', name: 'Bitcoin', symbol: 'BTC/USD', price: 0, prevPrice: 0, high: 0, low: 0 },
        { id: 'ethusd', name: 'Ethereum', symbol: 'ETH/USD', price: 0, prevPrice: 0, high: 0, low: 0 },
        { id: 'xauusd', name: 'Gold', symbol: 'XAU/USD', price: 0, prevPrice: 0, high: 0, low: 0 }
      ];
    }

    // UTIL
    function formatTime(ms){
      const totalSec = Math.ceil(ms/1000);
      const m = Math.floor(totalSec/60);
      const s = totalSec % 60;
      return m>0 ? `${m}m ${s}s` : `${s}s`;
    }

    // RENDER CARDS
    function renderAssets(){
      els.grid.innerHTML = window.assets.map(asset => `
        <div id="card-${asset.id}" class="market-card p-5 rounded-xl transition-all duration-300 border-l-4 border-gray-600">
          <div class="flex justify-between items-center mb-3">
            <h4 class="text-lg font-bold text-white">${asset.name}</h4>
            <label class="inline-block w-10 h-6 relative" aria-label="Toggle ${asset.name}">
              <input type="checkbox" class="asset-toggle absolute opacity-0" value="${asset.id}" checked>
              <span class="slider absolute inset-0 rounded-full"></span>
            </label>
          </div>
          <div class="mb-3">
            <span id="price-${asset.id}" class="text-3xl font-extrabold accent-yellow">${Number(asset.price).toFixed(2)}</span>
            <span class="text-sm text-gray-400 ml-2">${asset.symbol}</span>
          </div>
          <div class="flex justify-between items-center text-xs text-gray-400">
            <div id="change-text-${asset.id}" class="text-sm font-semibold">--</div>
            <div>
              H: <span id="high-${asset.id}">${Number(asset.high).toFixed(2)}</span>
              L: <span id="low-${asset.id}">${Number(asset.low).toFixed(2)}</span>
            </div>
          </div>
        </div>
      `).join('');
      document.querySelectorAll('.asset-toggle').forEach(cb => cb.addEventListener('change', updateSettings));
    }

    // UPDATE UI from window.assets
    function updateUI(){
      window.assets.forEach(asset => {
        const priceEl = document.getElementById(`price-${asset.id}`);
        const highEl = document.getElementById(`high-${asset.id}`);
        const lowEl = document.getElementById(`low-${asset.id}`);
        const changeEl = document.getElementById(`change-text-${asset.id}`);
        const cardEl = document.getElementById(`card-${asset.id}`);
        if (!priceEl) return;
        priceEl.innerText = Number(asset.price || 0).toFixed(2);
        highEl && (highEl.innerText = Number(asset.high || 0).toFixed(2));
        lowEl && (lowEl.innerText = Number(asset.low || 0).toFixed(2));
        const change = (asset.price || 0) - (asset.prevPrice || asset.price || 0);
        if (Math.abs(change) > 0.001) {
          const isUp = change >= 0;
          changeEl.className = `text-sm font-semibold ${isUp ? 'text-emerald-500' : 'text-rose-500'}`;
          changeEl.innerText = (isUp ? '▲ +' : '▼ ') + Math.abs(change).toFixed(2) + ' (live)';
          cardEl.classList.remove('border-emerald-500','border-rose-500','border-gray-600');
          cardEl.classList.add(isUp ? 'border-emerald-500' : 'border-rose-500');
        } else {
          changeEl.className = 'text-sm font-semibold text-gray-500';
          changeEl.innerText = '0.00';
          cardEl.classList.remove('border-emerald-500','border-rose-500');
          cardEl.classList.add('border-gray-600');
        }
      });
    }

    // SETTINGS
    function updateSettings(){
      window.STATE.intervalMs = parseInt(els.intervalSelect.value);
      window.STATE.voiceGender = els.voiceSelect.value;
      window.STATE.briefMode = els.briefMode.checked;
      window.STATE.fullPrecision = els.fullPrecision.checked;
      const intervalText = els.intervalSelect.options[els.intervalSelect.selectedIndex].text;
      els.frequencyText.innerText = `Announcement: Every ${intervalText}`;
      if (window.STATE.isRunning) restartAudioTimer();
      els.toggleBtn.innerText = window.STATE.isRunning ? 'Stop Earing' : `Start Earing (Every ${intervalText})`;
    }

    // TTS helpers
    let synth = window.speechSynthesis;

    function selectVoiceByName(name){
      const all = synth.getVoices() || [];
      return all.find(v => v.name === name) || all.find(v => v.lang && v.lang.startsWith('en')) || all[0] || null;
    }

    // Speak update (exposed globally)
    function speakUpdate(){
      if (!window.STATE.isRunning) return;
      synth.cancel();
      let phrase = '';
      // Only announce selected assets
      const selected = Array.from(document.querySelectorAll('.asset-toggle:checked')).map(i => i.value);
      window.assets.forEach(asset => {
        if (!asset || selected.indexOf(asset.id) === -1) return;
        let priceText = window.STATE.fullPrecision ? asset.price.toFixed(2).replace('.', ' point ') : Math.floor(asset.price).toString();
        if (window.STATE.briefMode) phrase += `${asset.name} at ${priceText}. `;
        else {
          const change = (asset.price || 0) - (asset.prevPrice || asset.price || 0);
          phrase += `${asset.name} at ${priceText}. Change ${change >= 0 ? 'up' : 'down'} by ${Math.abs(change).toFixed(2)} pips. `;
        }
      });
      phrase = phrase.trim();
      if (!phrase) return;
      const utt = new SpeechSynthesisUtterance(phrase);
      const chosen = selectVoiceByName(els.voiceSelect.value);
      if (chosen) utt.voice = chosen;
      utt.rate = 0.95;
      synth.speak(utt);
      resetCountdown();
    }

    // Expose speakUpdate & updateUI globally
    window.speakUpdate = speakUpdate;
    window.updateUI = updateUI;

    // Countdown & timer functions
    function resetCountdown(){
      window.STATE.remainingTime = window.STATE.intervalMs;
      els.countdownText.classList.remove('hidden');
      els.countdownText.innerText = `Next in: ${formatTime(window.STATE.remainingTime)}`;
    }
    function startAudioTimer(){
      // clear existing to prevent duplicates
      if (window.STATE.timers && window.STATE.timers.audio) {
        clearInterval(window.STATE.timers.audio);
        window.STATE.timers.audio = null;
      }
      window.STATE.timers.audio = setInterval(speakUpdate, window.STATE.intervalMs);
      // record for emergency cleanup
      window._activeIntervals = window._activeIntervals || [];
      window._activeIntervals.push(window.STATE.timers.audio);
    }
    function restartAudioTimer(){ if (window.STATE.isRunning) startAudioTimer(); }

    function toggleAudio(){
      if (!window.STATE.voiceReady) {
        alert('TTS not ready yet. Click the "▶ CLICK TO ALLOW TTS" button first.');
        return;
      }
      window.STATE.isRunning = !window.STATE.isRunning;
      if (window.STATE.isRunning) {
        els.toggleBtn.innerText = 'Stop Earing';
        els.statusText.innerText = 'Live Earing';
        startAudioTimer();
        speakUpdate();
      } else {
        els.toggleBtn.innerText = 'Start Earing';
        els.statusText.innerText = 'Ready';
        if (window.STATE.timers && window.STATE.timers.audio) { clearInterval(window.STATE.timers.audio); window.STATE.timers.audio = null; }
        try{ window.speechSynthesis.cancel(); }catch(e){}
        els.countdownText.classList.add('hidden');
      }
    }

    // Attach event listeners
    function setupListeners(){
      els.toggleBtn.addEventListener('click', toggleAudio);
      els.intervalSelect.addEventListener('change', () => {
        updateSettings();
      });
      els.voiceSelect.addEventListener('change', updateSettings);
      els.briefMode.addEventListener('change', updateSettings);
      els.fullPrecision.addEventListener('change', updateSettings);
      // initial settings populate
      updateSettings();
    }

    // Robust voice initialization & Test button + onboarding
    function initVoiceRobust(){
      function populateVoices(){
        const voices = synth.getVoices() || [];
        if (!voices.length) return;
        els.voiceSelect.innerHTML = '';
        const en = voices.filter(v => v.lang && v.lang.startsWith('en'));
        const rest = voices.filter(v => !(v.lang && v.lang.startsWith('en')));
        [...en, ...rest].forEach(v=>{
          const op = document.createElement('option');
          op.value = v.name;
          op.textContent = `${v.name} — ${v.lang}`;
          els.voiceSelect.appendChild(op);
        });
        window.STATE.voiceReady = true;
        els.toggleBtn.disabled = false;
        els.statusText.innerText = 'Ready';
        els.statusDot.classList.remove('bg-yellow-400');
        els.statusDot.classList.add('bg-sky-500');
      }
      try { populateVoices(); } catch(e){}
      synth.onvoiceschanged = populateVoices;

      // Create a visible Test Voice + Allow button (only if modal not dismissed)
      if (!localStorage.getItem('marketEar_audio_allowed')) {
        // show modal
        const modal = document.getElementById('__marketEarAllowModal');
        modal.style.display = 'flex';
        document.getElementById('__marketEarAllowBtn').onclick = () => {
          try {
            const voices = synth.getVoices() || [];
            const chosen = voices.find(v => v.lang && v.lang.startsWith('en')) || voices[0];
            const u = new SpeechSynthesisUtterance('Market Ear test. If you hear this, TTS is allowed.');
            if (chosen) u.voice = chosen;
            u.rate = 0.95;
            u.onend = () => { console.log('MarketEar: test TTS ended'); };
            u.onerror = (e) => { console.error('MarketEar: test TTS error', e); };
            synth.cancel();
            synth.speak(u);
            // user gesture happened — enable controls & hide modal
            localStorage.setItem('marketEar_audio_allowed','1');
            window.STATE.voiceReady = true;
            els.toggleBtn.disabled = false;
            els.statusText.innerText = 'Ready';
            modal.style.display = 'none';
            console.log('MarketEar: Test spoken. Now click Start Earing to begin announcements.');
          } catch(err){
            console.error('MarketEar: test voice failed', err);
          }
        };
      } else {
        // already accepted — ensure voices populated
        try { populateVoices(); } catch(e){}
      }
    }

    // Initial render + listeners + voice init
    renderAssets();
    setupListeners();
    initVoiceRobust();

    // Keep UI synced every second (bridge will call updateUI on message too)
    setInterval(()=>{ try{ updateUI(); if (window.STATE.isRunning){ window.STATE.remainingTime = Math.max(0, (window.STATE.remainingTime||window.STATE.intervalMs) - 1000); els.countdownText.innerText = `Next in: ${formatTime(window.STATE.remainingTime)}`; } } catch(e){} }, 1000);

    // Expose small debug helpers
    window.MarketEarDebug = {
      enable: ()=>{ window.STATE.voiceReady = true; els.toggleBtn.disabled = false; console.log('MarketEarDebug: enabled'); },
      speakNow: ()=>{ window.STATE.isRunning = true; speakUpdate(); },
      stopNow: ()=>{ window.STATE.isRunning = false; if(window.STATE.timers && window.STATE.timers.audio) { clearInterval(window.STATE.timers.audio); window.STATE.timers.audio = null;} window.speechSynthesis.cancel(); console.log('MarketEarDebug: stopped'); }
    };

  })();
  </script>

  <!-- LIVE BRIDGE (must exist in repo root) -->
  <script src="live-crypto.js"></script>

  <!-- Service worker registration (already points to /MarketEar/service-worker.js) -->
  <script>
    if ('serviceWorker' in navigator) {
      window.addEventListener('load', function() {
        navigator.serviceWorker.register('/MarketEar/service-worker.js')
          .then(function(reg) {
            console.log('MarketEar: serviceWorker registered.', reg.scope);
          }).catch(function(err) {
            console.warn('MarketEar: serviceWorker registration failed:', err);
          });
      });
    }
  </script>

</body>
</html>
