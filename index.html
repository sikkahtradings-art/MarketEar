<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>MarketEar Pro | Eyes-Free Audio Trading</title>

  <!-- Manifest for PWA -->
  <link rel="manifest" href="/MarketEar/manifest.json">
  <meta name="theme-color" content="#fcd34d">

  <!-- Tailwind CDN (ok for testing) -->
  <script src="https://cdn.tailwindcss.com"></script>
  <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;600;700;800;900&display=swap" rel="stylesheet">

  <style>
    body { font-family: 'Inter', sans-serif; background:#1a1e23; color:#e2e8f0; }
    .market-card { background:#242930; border:1px solid #30363d; box-shadow:0 4px 6px rgba(0,0,0,0.2); }
    .accent-yellow{ color:#fcd34d; } .bg-accent-yellow{ background:#fcd34d; }
    .slider{ background:#4b5563; transition:.4s; }
    .slider:before{ content:""; position:absolute; height:1rem; width:1rem; left:0.25rem; bottom:0.25rem; background:#fff; transition:.4s; border-radius:9999px; }
    .asset-toggle-visible { width:22px; height:22px; accent-color:#fcd34d; cursor:pointer; }
  </style>
</head>
<body class="flex flex-col min-h-screen">

  <!-- Header -->
  <header class="bg-gray-900 border-b border-gray-700 sticky top-0 z-50">
    <div class="max-w-7xl mx-auto px-4 py-4 flex justify-between items-center">
      <div class="flex items-center">
        <div class="bg-yellow-400 p-2 rounded-lg mr-3 shadow-lg border border-yellow-200">
          <svg viewBox="0 0 45 28" class="w-12 h-8"><text x="-2" y="25" font-size="36" font-weight="900" fill="#10b981">M</text><text x="23" y="25" font-size="36" font-weight="900" fill="#f43f5e">E</text></svg>
        </div>
        <div>
          <h1 class="text-2xl font-extrabold text-white">MarketEar Pro</h1>
          <p class="text-sm text-gray-400">Eyes-free audio price announcement engine</p>
        </div>
      </div>

      <div class="flex items-center space-x-4">
        <div id="status-badge" class="px-4 py-2 rounded-xl text-sm font-semibold bg-gray-700 flex items-center">
          <span id="status-dot" class="w-3 h-3 rounded-full bg-yellow-400 mr-3 animate-pulse"></span>
          <div class="flex flex-col">
            <span id="status-text" class="text-white font-bold">Initializing...</span>
            <span id="frequency-text" class="text-xs text-gray-400">--</span>
            <span id="countdown-text" class="text-xs hidden mt-0.5"></span>
          </div>
        </div>

        <button id="toggle-btn" aria-label="Start or stop audio announcements" class="bg-accent-yellow text-gray-900 px-6 py-2 rounded-xl font-bold disabled:opacity-50" disabled>
          Loading Voice...
        </button>
      </div>
    </div>
  </header>

  <!-- Main -->
  <main class="flex-grow max-w-7xl mx-auto px-4 py-8 w-full">
    <section class="mb-6">
      <h2 class="text-xl font-bold text-white">Active Portfolio</h2>
      <p class="text-gray-400 text-sm">Toggle which assets are announced. Prices update live.</p>
    </section>

    <section id="assets-grid" class="grid grid-cols-1 md:grid-cols-3 gap-6 mb-8">
      <!-- cards injected by JS -->
    </section>

    <section class="bg-gray-800 market-card rounded-xl p-6">
      <h3 class="text-lg font-semibold text-white mb-4">Audio & Content Settings</h3>
      <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
        <div>
          <label class="text-sm text-gray-300">Update Frequency</label>
          <select id="interval-select" class="w-full bg-gray-700 border border-gray-600 text-white rounded p-2">
            <option value="15000">15 Seconds</option>
            <option value="30000" selected>30 Seconds</option>
            <option value="60000">1 Minute</option>
            <option value="120000">2 Minutes</option>
            <option value="300000">5 Minutes</option>
          </select>
        </div>
        <div>
          <label class="text-sm text-gray-300">Voice</label>
          <select id="voice-select" class="w-full bg-gray-700 border border-gray-600 text-white rounded p-2">
            <option value="default" selected>Default</option>
          </select>
        </div>

        <div>
          <label class="flex items-center justify-between text-sm text-gray-300">
            <span>Full Price Precision</span>
            <input id="full-precision" type="checkbox" class="ml-2">
          </label>
        </div>

        <div>
          <label class="flex items-center justify-between text-sm text-gray-300">
            <span>Price Only (Brief)</span>
            <input id="brief-mode" type="checkbox" checked class="ml-2">
          </label>
        </div>
      </div>
    </section>
  </main>

  <footer class="bg-gray-900 text-gray-500 py-4 text-center text-xs border-t border-gray-800">
    <p>MarketEar Pro | For informational purposes only.</p>
  </footer>

  <!-- Allow-audio onboarding modal -->
  <div id="__marketEarAllowModal" style="display:none">
    <div id="__marketEarAllowBox" style="position:fixed; inset:0; display:flex; align-items:center; justify-content:center; z-index:99998;">
      <div style="background:#0b1220; border:1px solid #2a2f36; padding:20px; border-radius:12px; box-shadow:0 12px 40px rgba(0,0,0,.6); color:#e6eef8; max-width:420px; text-align:center;">
        <h3 style="font-weight:800;margin-bottom:8px">Allow Audio</h3>
        <p style="color:#b9c6d6;margin-bottom:12px">Click the button below so your browser allows MarketEar to speak price announcements. This is required only once.</p>
        <button id="__marketEarAllowBtn" style="background:#facc15;color:#111;padding:10px 14px;border-radius:8px;font-weight:700">▶ Enable Audio</button>
      </div>
    </div>
  </div>

  <!-- MarketEar core logic -->
  <script>
  // Global state
  window.STATE = window.STATE || {
    isRunning: false,
    voiceReady: false,
    intervalMs: 30000,
    briefMode: true,
    fullPrecision: false,
    voiceGender: 'female',
    selectedAssets: [],
    timers: { audio: null },
    remainingTime: 0
  };

  (function(){
    // Elements
    const els = {
      grid: document.getElementById('assets-grid'),
      toggleBtn: document.getElementById('toggle-btn'),
      statusText: document.getElementById('status-text'),
      statusDot: document.getElementById('status-dot'),
      frequencyText: document.getElementById('frequency-text'),
      countdownText: document.getElementById('countdown-text'),
      intervalSelect: document.getElementById('interval-select'),
      voiceSelect: document.getElementById('voice-select'),
      briefMode: document.getElementById('brief-mode'),
      fullPrecision: document.getElementById('full-precision')
    };

    // If no bridge-provided assets yet, set defaults (bridge will update them)
    if (!window.assets || !Array.isArray(window.assets)) {
      window.assets = [
        { id: 'btcusd', name: 'Bitcoin', symbol: 'BTC/USD', price: 0, prevPrice: 0, high: 0, low: 0 },
        { id: 'ethusd', name: 'Ethereum', symbol: 'ETH/USD', price: 0, prevPrice: 0, high: 0, low: 0 },
        { id: 'xauusd', name: 'Gold', symbol: 'XAU/USD', price: 0, prevPrice: 0, high: 0, low: 0 }
      ];
    }

    // Utility
    function formatTime(ms){ const s=Math.ceil(ms/1000); const m=Math.floor(s/60); const sec=s%60; return m>0?`${m}m ${sec}s`:`${sec}s`; }

    // Render asset cards (with visible checkbox toggles)
    function renderAssets(){
      els.grid.innerHTML = window.assets.map(asset => `
        <div id="card-${asset.id}" class="market-card p-5 rounded-xl transition-all duration-300 border-l-4 border-gray-600">
          <div class="flex justify-between items-center mb-3">
            <h4 class="text-lg font-bold text-white">${asset.name}</h4>
            <div class="flex items-center gap-2">
              <input type="checkbox" class="asset-toggle asset-toggle-visible" value="${asset.id}" aria-label="Listen ${asset.name}">
              <span class="text-xs text-gray-300">Listen</span>
            </div>
          </div>
          <div class="mb-3">
            <span id="price-${asset.id}" class="text-3xl font-extrabold accent-yellow">${Number(asset.price).toFixed(2)}</span>
            <span class="text-sm text-gray-400 ml-2">${asset.symbol}</span>
          </div>
          <div class="flex justify-between items-center text-xs text-gray-400">
            <div id="change-text-${asset.id}" class="text-sm font-semibold">--</div>
            <div>
              H: <span id="high-${asset.id}">${Number(asset.high).toFixed(2)}</span>
              L: <span id="low-${asset.id}">${Number(asset.low).toFixed(2)}</span>
            </div>
          </div>
        </div>
      `).join('');

      // Attach change listeners for checkboxes
      document.querySelectorAll('.asset-toggle').forEach(cb=>{
        cb.addEventListener('change', function(){
          // update selectedAssets
          window.STATE.selectedAssets = Array.from(document.querySelectorAll('.asset-toggle:checked')).map(i=>i.value);
          console.log('MarketEar: selectedAssets ->', window.STATE.selectedAssets);
          // call updateSettings to refresh UI text if needed
          updateSettings();
        });
      });
      // sync initial selected list
      window.STATE.selectedAssets = Array.from(document.querySelectorAll('.asset-toggle:checked')).map(i=>i.value);
    }

    // Update UI prices & change
    function updateUI(){
      window.assets.forEach(asset=>{
        const priceEl = document.getElementById(`price-${asset.id}`);
        const changeEl = document.getElementById(`change-text-${asset.id}`);
        const highEl = document.getElementById(`high-${asset.id}`);
        const lowEl = document.getElementById(`low-${asset.id}`);
        const cardEl = document.getElementById(`card-${asset.id}`);
        if (!priceEl) return;
        priceEl.innerText = Number(asset.price || 0).toFixed(2);
        highEl && (highEl.innerText = Number(asset.high || 0).toFixed(2));
        lowEl && (lowEl.innerText = Number(asset.low || 0).toFixed(2));
        const change = (asset.price || 0) - (asset.prevPrice || asset.price || 0);
        if (Math.abs(change) > 0.0001) {
          const isUp = change >= 0;
          changeEl.className = `text-sm font-semibold ${isUp ? 'text-emerald-500' : 'text-rose-500'}`;
          changeEl.innerText = (isUp ? '▲ +' : '▼ ') + Math.abs(change).toFixed(2) + ' (live)';
          cardEl.classList.remove('border-emerald-500','border-rose-500','border-gray-600');
          cardEl.classList.add(isUp ? 'border-emerald-500' : 'border-rose-500');
        } else {
          changeEl.className = 'text-sm font-semibold text-gray-500';
          changeEl.innerText = '0.00';
          cardEl.classList.remove('border-emerald-500','border-rose-500');
          cardEl.classList.add('border-gray-600');
        }
      });
    }

    // Update settings UI text
    function updateSettings(){
      window.STATE.intervalMs = parseInt(els.intervalSelect.value);
      window.STATE.briefMode = !!els.briefMode.checked;
      window.STATE.fullPrecision = !!els.fullPrecision.checked;
      const intervalText = els.intervalSelect.options[els.intervalSelect.selectedIndex].text;
      els.frequencyText.innerText = `Announcement: Every ${intervalText}`;
      // set default selection if none
      if (!window.STATE.selectedAssets || !window.STATE.selectedAssets.length) {
        // if none checked, default to btc & eth if exist
        const defaultIds = window.assets.map(a=>a.id).slice(0,2);
        document.querySelectorAll('.asset-toggle').forEach(i=>{ i.checked = defaultIds.includes(i.value); });
        window.STATE.selectedAssets = Array.from(document.querySelectorAll('.asset-toggle:checked')).map(i=>i.value);
      }
      // update toggle button text
      els.toggleBtn.innerText = window.STATE.isRunning ? 'Stop Earing' : `Start Earing (Every ${intervalText})`;
    }

    // TTS speak update (respects selectedAssets)
    function speakUpdate(){
      try {
        if (!window.STATE || !window.STATE.isRunning) return;
        // cancel overlapping
        window.speechSynthesis.cancel();

        const selected = Array.from(document.querySelectorAll('.asset-toggle:checked')).map(i=>i.value);
        if (!selected.length) { console.log('MarketEar: no assets selected — skipping speak'); return; }

        const parts = [];
        window.assets.forEach(asset=>{
          if (!asset) return;
          if (selected.indexOf(asset.id) === -1) return;
          const price = asset.price || 0;
          const priceText = window.STATE.fullPrecision ? price.toFixed(2).replace('.', ' point ') : Math.floor(price).toString();
          if (window.STATE.briefMode) parts.push(`${asset.name} at ${priceText}`);
          else {
            const change = (asset.price || 0) - (asset.prevPrice || asset.price || 0);
            parts.push(`${asset.name} at ${priceText}. Change ${change>=0?'up':'down'} by ${Math.abs(change).toFixed(2)} pips`);
          }
        });

        if (!parts.length) { console.log('MarketEar: selected assets have no data yet'); return; }
        const phrase = parts.join('. ') + '.';
        const udp = new SpeechSynthesisUtterance(phrase);
        udp.rate = 0.95;
        const voices = speechSynthesis.getVoices() || [];
        const chosen = voices.find(v => v.name === els.voiceSelect.value) || voices.find(v => v.lang && v.lang.startsWith('en')) || voices[0];
        if (chosen) udp.voice = chosen;
        speechSynthesis.speak(udp);
        // reset canonical next time
        window._marketEarNextAt = Date.now() + (window.STATE.intervalMs || 30000);
        if (typeof resetCountdown === 'function') resetCountdown();
        console.log('MarketEar: spoken ->', phrase);
      } catch(e){
        console.error('MarketEar: speakUpdate error', e);
      }
    }

    // resetCountdown helper
    function resetCountdown(){
      window.STATE.remainingTime = window.STATE.intervalMs || 30000;
      const el = document.getElementById('countdown-text');
      if (el) el.innerText = 'Next in: ' + formatTime(window.STATE.remainingTime);
    }

    // Start/Stop handler using canonical scheduling
    function attachToggleButton(){
      const btn = els.toggleBtn;
      // safe remove old handlers
      btn.disabled = false;
      btn.onclick = null;
      btn.addEventListener('click', function(){
        try {
          window.STATE.isRunning = !window.STATE.isRunning;
          if (window.STATE.isRunning) {
            // ensure next timestamp
            window._marketEarNextAt = Date.now() + (window.STATE.intervalMs || 30000);
            // clear old
            if (window.STATE.timers && window.STATE.timers.audio) { clearInterval(window.STATE.timers.audio); window.STATE.timers.audio = null; }
            // set interval
            window.STATE.timers.audio = setInterval(speakUpdate, window.STATE.intervalMs || 30000);
            // speak immediately
            speakUpdate();
            btn.innerText = 'Stop Earing';
            els.statusText.innerText = 'Live Earing';
            console.log('MarketEar: started announcements. Next at', new Date(window._marketEarNextAt).toLocaleTimeString());
          } else {
            // stop
            if (window.STATE.timers && window.STATE.timers.audio) { clearInterval(window.STATE.timers.audio); window.STATE.timers.audio = null; }
            try { window.speechSynthesis.cancel(); } catch(e){}
            btn.innerText = 'Start Earing';
            els.statusText.innerText = 'Ready';
            // hide countdown
            document.getElementById('countdown-text').classList.add('hidden');
            console.log('MarketEar: stopped announcements.');
          }
        } catch(e){ console.error('MarketEar: toggle error', e); }
      });
    }

    // Countdown updater tied to _marketEarNextAt
    function attachCountdownUpdater(){
      if (window._marketEarCountdownInterval) { clearInterval(window._marketEarCountdownInterval); window._marketEarCountdownInterval = null; }
      window._marketEarCountdownInterval = setInterval(function(){
        try {
          const el = document.getElementById('countdown-text');
          if (!el) return;
          if (!(window.STATE && window.STATE.isRunning)) { el.classList.add('hidden'); return; }
          if (!window._marketEarNextAt) window._marketEarNextAt = Date.now() + (window.STATE.intervalMs || 30000);
          const remainingMs = Math.max(0, window._marketEarNextAt - Date.now());
          if (window.STATE) window.STATE.remainingTime = remainingMs;
          el.classList.remove('hidden');
          el.classList.remove('text-red-400','text-emerald-300');
          if (remainingMs <= 5000) el.classList.add('text-red-400'); else el.classList.add('text-emerald-300');
          el.innerText = 'Next in: ' + formatTime(remainingMs);
        } catch(e){}
      }, 250);
    }

    // Voice initialization & onboarding modal
    function initVoice(){
      const synth = window.speechSynthesis;
      function populate(){
        const v = synth.getVoices() || [];
        if (!v.length) return;
        els.voiceSelect.innerHTML = '';
        const english = v.filter(x=>x.lang && x.lang.startsWith('en'));
        const rest = v.filter(x=>!(x.lang && x.lang.startsWith('en')));
        [...english,...rest].forEach(vc=>{
          const op = document.createElement('option');
          op.value = vc.name;
          op.textContent = `${vc.name} — ${vc.lang}`;
          els.voiceSelect.appendChild(op);
        });
        window.STATE.voiceReady = true;
        els.toggleBtn.disabled = false;
        els.statusText.innerText = 'Ready';
        els.statusDot.classList.remove('bg-yellow-400');
        els.statusDot.classList.add('bg-sky-500');
      }
      populate();
      synth.onvoiceschanged = populate;

      // onboarding
      if (!localStorage.getItem('marketEar_audio_allowed')) {
        const modal = document.getElementById('__marketEarAllowModal');
        modal.style.display = 'block';
        document.getElementById('__marketEarAllowBtn').onclick = function(){
          try {
            const voices = synth.getVoices() || [];
            const chosen = voices.find(v=>v.lang && v.lang.startsWith('en')) || voices[0];
            const u = new SpeechSynthesisUtterance('Market Ear test. If you hear this, TTS is allowed.');
            if (chosen) u.voice = chosen;
            u.rate = 0.95;
            u.onend = ()=>{ console.log('MarketEar: test TTS ended'); };
            synth.cancel();
            synth.speak(u);
            localStorage.setItem('marketEar_audio_allowed','1');
            window.STATE.voiceReady = true;
            els.toggleBtn.disabled = false;
            els.statusText.innerText = 'Ready';
            modal.style.display = 'none';
            console.log('MarketEar: Test spoken. Now click Start Earing to begin announcements.');
          } catch(e){ console.error('MarketEar: test voice failed', e); }
        };
      } else {
        // already allowed
        document.getElementById('__marketEarAllowModal').style.display = 'none';
      }
    }

    // When interval changes, restart timer if running
    function attachIntervalChangeHandler(){
      els.intervalSelect.addEventListener('change', function(){
        try {
          window.STATE.intervalMs = parseInt(els.intervalSelect.value);
          if (window.STATE.isRunning) {
            // restart audio timer with new interval
            if (window.STATE.timers && window.STATE.timers.audio) { clearInterval(window.STATE.timers.audio); window.STATE.timers.audio = null; }
            window.STATE.timers.audio = setInterval(speakUpdate, window.STATE.intervalMs);
            window._marketEarNextAt = Date.now() + window.STATE.intervalMs;
          } else {
            window._marketEarNextAt = Date.now() + window.STATE.intervalMs;
          }
          updateSettings();
        } catch(e){ console.warn('MarketEar: interval change error', e); }
      });
    }

    // INITIAL SETUP
    renderAssets();
    updateSettings();
    attachToggleButton();
    attachCountdownUpdater();
    attachIntervalChangeHandler();
    initVoice();

    // Keep UI updated from global assets (bridge will update these frequently)
    setInterval(function(){ try{ updateUI(); } catch(e){} }, 900);

    // Expose functions for debugging
    window.MarketEar = {
      speakNow: speakUpdate,
      updateUI: updateUI,
      renderAssets: renderAssets,
      updateSettings: updateSettings,
      stop: function(){ window.STATE.isRunning=false; if(window.STATE.timers && window.STATE.timers.audio){ clearInterval(window.STATE.timers.audio); window.STATE.timers.audio=null;} try{speechSynthesis.cancel();}catch(e){}; els.toggleBtn.innerText='Start Earing'; els.statusText.innerText='Ready'; }
    };

  })();
  </script>

  <!-- Live bridge (your WS script). Keep this file in repo root /MarketEar/live-crypto.js -->
  <script src="live-crypto.js"></script>

  <!-- Service worker registration -->
  <script>
    if ('serviceWorker' in navigator) {
      window.addEventListener('load', function() {
        navigator.serviceWorker.register('/MarketEar/service-worker.js')
          .then(function(reg) {
            console.log('MarketEar: serviceWorker registered.', reg.scope);
          }).catch(function(err) {
            console.warn('MarketEar: serviceWorker registration failed:', err);
          });
      });
    }
  </script>
</body>
</html>
