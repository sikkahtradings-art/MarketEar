<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>MarketEar Pro | Eyes-Free Audio Trading</title>

  <!-- Tailwind CDN (fine for testing) -->
  <script src="https://cdn.tailwindcss.com"></script>
  <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;600;700;800;900&display=swap" rel="stylesheet">

  <style>
    body { font-family: 'Inter', sans-serif; background:#1a1e23; color:#e2e8f0; }
    .market-card { background:#242930; border:1px solid #30363d; box-shadow:0 4px 6px rgba(0,0,0,0.2); }
    .accent-yellow{ color:#fcd34d; } .bg-accent-yellow{ background:#fcd34d; }
    .slider{ background:#4b5563; transition:.4s; }
    .slider:before{ content:""; position:absolute; height:1rem; width:1rem; left:0.25rem; bottom:0.25rem; background:#fff; transition:.4s; border-radius:9999px; }
    /* quick Test Voice button style */
    #__marketEarTestBtn { position:fixed; bottom:14px; right:14px; z-index:9999; padding:10px 12px; background:#facc15; color:#111; font-weight:700; border-radius:8px; box-shadow:0 6px 18px rgba(0,0,0,0.25); }
  </style>
</head>
<body class="flex flex-col min-h-screen">

  <!-- Header -->
  <header class="bg-gray-900 border-b border-gray-700 sticky top-0 z-50">
    <div class="max-w-7xl mx-auto px-4 py-4 flex justify-between items-center">
      <div class="flex items-center">
        <div class="bg-yellow-400 p-2 rounded-lg mr-3 shadow-lg border border-yellow-200">
          <svg viewBox="0 0 45 28" class="w-12 h-8"><text x="-2" y="25" font-size="36" font-weight="900" fill="#10b981">M</text><text x="23" y="25" font-size="36" font-weight="900" fill="#f43f5e">E</text></svg>
        </div>
        <div>
          <h1 class="text-2xl font-extrabold text-white">MarketEar Pro</h1>
          <p class="text-sm text-gray-400">Eyes-free audio price announcement engine</p>
        </div>
      </div>

      <div class="flex items-center space-x-4">
        <div id="status-badge" class="px-4 py-2 rounded-xl text-sm font-semibold bg-gray-700 flex items-center">
          <span id="status-dot" class="w-3 h-3 rounded-full bg-yellow-400 mr-3 animate-pulse"></span>
          <div class="flex flex-col">
            <span id="status-text" class="text-white font-bold">Initializing...</span>
            <span id="frequency-text" class="text-xs text-gray-400">--</span>
            <span id="countdown-text" class="text-xs hidden"></span>
          </div>
        </div>

        <button id="toggle-btn" class="bg-accent-yellow text-gray-900 px-6 py-2 rounded-xl font-bold disabled:opacity-50" disabled>
          Loading Voice...
        </button>
      </div>
    </div>
  </header>

  <!-- Main -->
  <main class="flex-grow max-w-7xl mx-auto px-4 py-8 w-full">
    <section class="mb-6">
      <h2 class="text-xl font-bold text-white">Active Portfolio</h2>
      <p class="text-gray-400 text-sm">Toggle which assets are announced. Prices update live.</p>
    </section>

    <section id="assets-grid" class="grid grid-cols-1 md:grid-cols-3 gap-6 mb-8">
      <!-- cards injected by JS -->
    </section>

    <section class="bg-gray-800 market-card rounded-xl p-6">
      <h3 class="text-lg font-semibold text-white mb-4">Audio & Content Settings</h3>
      <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
        <div>
          <label class="text-sm text-gray-300">Update Frequency</label>
          <select id="interval-select" class="w-full bg-gray-700 border border-gray-600 text-white rounded p-2">
            <option value="15000">15 Seconds</option>
            <option value="30000" selected>30 Seconds</option>
            <option value="60000">1 Minute</option>
            <option value="120000">2 Minutes</option>
          </select>
        </div>
        <div>
          <label class="text-sm text-gray-300">Voice</label>
          <select id="voice-select" class="w-full bg-gray-700 border border-gray-600 text-white rounded p-2">
            <option value="default" selected>Default</option>
          </select>
        </div>

        <div>
          <label class="flex items-center justify-between text-sm text-gray-300">
            <span>Full Price Precision</span>
            <input id="full-precision" type="checkbox" class="ml-2">
          </label>
        </div>

        <div>
          <label class="flex items-center justify-between text-sm text-gray-300">
            <span>Price Only (Brief)</span>
            <input id="brief-mode" type="checkbox" checked class="ml-2">
          </label>
        </div>
      </div>
    </section>
  </main>

  <!-- Footer -->
  <footer class="bg-gray-900 text-gray-500 py-4 text-center text-xs border-t border-gray-800">
    <p>MarketEar Pro | For informational purposes only.</p>
  </footer>

  <!-- Application Script -->
  <script>
  (function(){
    // Page state
    const STATE = {
      isRunning: false,
      voiceReady: false,
      intervalMs: 30000,
      briefMode: true,
      fullPrecision: false,
      voiceGender: 'female',
      timers: { audio: null },
      remainingTime: 0
    };

    // Ensure global assets (bridge updates window.assets)
    if (!window.assets || !Array.isArray(window.assets)) {
      window.assets = [
        { id: 'btcusd', name: 'Bitcoin', symbol: 'BTC/USD', price: 0, prevPrice: 0, high: 0, low: 0 },
        { id: 'ethusd', name: 'Ethereum', symbol: 'ETH/USD', price: 0, prevPrice: 0, high: 0, low: 0 }
      ];
    }

    // DOM refs
    const els = {
      grid: document.getElementById('assets-grid'),
      toggleBtn: document.getElementById('toggle-btn'),
      statusText: document.getElementById('status-text'),
      statusDot: document.getElementById('status-dot'),
      frequencyText: document.getElementById('frequency-text'),
      countdownText: document.getElementById('countdown-text'),
      intervalSelect: document.getElementById('interval-select'),
      voiceSelect: document.getElementById('voice-select'),
      briefMode: document.getElementById('brief-mode'),
      fullPrecision: document.getElementById('full-precision')
    };

    // utilities
    function formatTime(ms){
      const totalSec = Math.ceil(ms/1000);
      const m = Math.floor(totalSec/60);
      const s = totalSec % 60;
      return m>0 ? `${m}m ${s}s` : `${s}s`;
    }

    // render cards
    function renderAssets(){
      els.grid.innerHTML = window.assets.map(asset => `
        <div id="card-${asset.id}" class="market-card p-5 rounded-xl transition-all duration-300 border-l-4 border-gray-600">
          <div class="flex justify-between items-center mb-3">
            <h4 class="text-lg font-bold text-white">${asset.name}</h4>
            <label class="inline-block w-10 h-6 relative">
              <input type="checkbox" class="asset-toggle absolute opacity-0" value="${asset.id}" checked>
              <span class="slider absolute inset-0 rounded-full"></span>
            </label>
          </div>
          <div class="mb-3">
            <span id="price-${asset.id}" class="text-3xl font-extrabold accent-yellow">${Number(asset.price).toFixed(2)}</span>
            <span class="text-sm text-gray-400 ml-2">${asset.symbol}</span>
          </div>
          <div class="flex justify-between items-center text-xs text-gray-400">
            <div id="change-text-${asset.id}" class="text-sm font-semibold">--</div>
            <div>
              H: <span id="high-${asset.id}">${Number(asset.high).toFixed(2)}</span>
              L: <span id="low-${asset.id}">${Number(asset.low).toFixed(2)}</span>
            </div>
          </div>
        </div>
      `).join('');
      document.querySelectorAll('.asset-toggle').forEach(cb => cb.addEventListener('change', updateSettings));
    }

    // update UI from window.assets
    function updateUI(){
      window.assets.forEach(asset => {
        const priceEl = document.getElementById(`price-${asset.id}`);
        const highEl = document.getElementById(`high-${asset.id}`);
        const lowEl = document.getElementById(`low-${asset.id}`);
        const changeEl = document.getElementById(`change-text-${asset.id}`);
        const cardEl = document.getElementById(`card-${asset.id}`);
        if (!priceEl) return;
        priceEl.innerText = Number(asset.price || 0).toFixed(2);
        highEl && (highEl.innerText = Number(asset.high || 0).toFixed(2));
        lowEl && (lowEl.innerText = Number(asset.low || 0).toFixed(2));
        const change = (asset.price || 0) - (asset.prevPrice || asset.price || 0);
        if (Math.abs(change) > 0.001) {
          const isUp = change >= 0;
          changeEl.className = `text-sm font-semibold ${isUp ? 'text-emerald-500' : 'text-rose-500'}`;
          changeEl.innerText = (isUp ? '▲ +' : '▼ ') + Math.abs(change).toFixed(2) + ' (live)';
          cardEl.classList.remove('border-emerald-500','border-rose-500','border-gray-600');
          cardEl.classList.add(isUp ? 'border-emerald-500' : 'border-rose-500');
        } else {
          changeEl.className = 'text-sm font-semibold text-gray-500';
          changeEl.innerText = '0.00';
          cardEl.classList.remove('border-emerald-500','border-rose-500');
          cardEl.classList.add('border-gray-600');
        }
      });
    }

    // settings
    function setupListeners(){
      els.toggleBtn.addEventListener('click', toggleAudio);
      els.intervalSelect.addEventListener('change', () => {
        STATE.intervalMs = parseInt(els.intervalSelect.value);
        els.frequencyText.innerText = `Announcement: Every ${els.intervalSelect.options[els.intervalSelect.selectedIndex].text}`;
        if (STATE.isRunning) restartAudioTimer();
      });
      els.voiceSelect.addEventListener('change', () => STATE.voiceGender = els.voiceSelect.value);
      els.briefMode.addEventListener('change', () => STATE.briefMode = els.briefMode.checked);
      els.fullPrecision.addEventListener('change', () => STATE.fullPrecision = els.fullPrecision.checked);
    }

    // TTS
    let voices = [];
    let synth = window.speechSynthesis;

    function selectVoiceByName(name){
      const all = synth.getVoices() || [];
      return all.find(v => v.name === name) || all.find(v => v.lang && v.lang.startsWith('en')) || all[0] || null;
    }

    function speakUpdate(){
      if (!STATE.isRunning) return;
      synth.cancel();
      let phrase = '';
      window.assets.forEach(asset => {
        let priceText = STATE.fullPrecision ? asset.price.toFixed(2).replace('.', ' point ') : Math.floor(asset.price).toString();
        if (STATE.briefMode) phrase += `${asset.name} at ${priceText}. `;
        else {
          const change = (asset.price || 0) - (asset.prevPrice || asset.price || 0);
          phrase += `${asset.name} at ${priceText}. Change ${change >= 0 ? 'up' : 'down'} by ${Math.abs(change).toFixed(2)} pips. `;
        }
      });
      if (!phrase.trim()) return;
      const utter = new SpeechSynthesisUtterance(phrase.trim());
      const chosen = selectVoiceByName(els.voiceSelect.value);
      if (chosen) utter.voice = chosen;
      utter.rate = 0.95;
      synth.speak(utter);
      resetCountdown();
    }

    function resetCountdown(){
      STATE.remainingTime = STATE.intervalMs;
      els.countdownText.classList.remove('hidden');
      els.countdownText.innerText = `Next in: ${formatTime(STATE.remainingTime)}`;
    }

    function startAudioTimer(){
      clearInterval(STATE.timers.audio);
      STATE.timers.audio = setInterval(speakUpdate, STATE.intervalMs);
    }
    function restartAudioTimer(){ if (STATE.isRunning) startAudioTimer(); }

    function toggleAudio(){
      if (!STATE.voiceReady) return;
      STATE.isRunning = !STATE.isRunning;
      if (STATE.isRunning) {
        els.toggleBtn.innerText = 'Stop Earing';
        els.statusText.innerText = 'Live Earing';
        startAudioTimer();
        speakUpdate();
      } else {
        els.toggleBtn.innerText = 'Start Earing';
        els.statusText.innerText = 'Ready';
        clearInterval(STATE.timers.audio);
        synth.cancel();
        els.countdownText.classList.add('hidden');
      }
    }

    // Expose updateUI so bridge can call
    window.updateUI = updateUI;

    // Render & init
    renderAssets();
    setupListeners();
    els.frequencyText.innerText = `Announcement: Every ${els.intervalSelect.options[els.intervalSelect.selectedIndex].text}`;

    // Robust voice init: populate voices, enable controls once user gesture occurs
    (function initVoiceRobust(){
      const toggleBtn = els.toggleBtn;
      const voiceSelect = els.voiceSelect;
      const statusText = els.statusText;
      const statusDot = els.statusDot;

      function setReady() {
        if (toggleBtn) {
          toggleBtn.disabled = false;
          toggleBtn.innerText = STATE.isRunning ? 'Stop Earing' : 'Start Earing';
        }
        if (statusText) statusText.innerText = 'Ready';
        if (statusDot) { statusDot.classList.remove('bg-yellow-400'); statusDot.classList.add('bg-sky-500'); }
        STATE.voiceReady = true;
      }

      function populateVoices(){
        const v = window.speechSynthesis.getVoices() || [];
        if (!v || v.length === 0) return;
        voiceSelect.innerHTML = '';
        const en = v.filter(x => x.lang && x.lang.startsWith('en'));
        const rest = v.filter(x => !(x.lang && x.lang.startsWith('en')));
        [...en, ...rest].forEach(vo=>{
          const o = document.createElement('option');
          o.value = vo.name;
          o.textContent = `${vo.name} — ${vo.lang}`;
          voiceSelect.appendChild(o);
        });
        setReady();
      }

      try { populateVoices(); } catch(e){}
      window.speechSynthesis.onvoiceschanged = populateVoices;

      // Add Test Voice button for the first user gesture (if not present)
      if (!document.getElementById('__marketEarTestBtn')) {
        const tb = document.createElement('button');
        tb.id = '__marketEarTestBtn';
        tb.textContent = 'Test Voice';
        tb.onclick = () => {
          const chosen = selectVoiceByName(voiceSelect.value);
          const utt = new SpeechSynthesisUtterance('Testing Market Ear. If you hear me, TTS is working.');
          if (chosen) utt.voice = chosen;
          utt.rate = 0.95;
          window.speechSynthesis.cancel();
          window.speechSynthesis.speak(utt);
          // user gesture occurred — enable controls
          setReady();
        };
        document.body.appendChild(tb);
      }
      // If voices already present, ensure ready
      if ((window.speechSynthesis.getVoices() || []).length > 0) populateVoices();
    })();

    // Keep UI in sync: update every second (bridge also calls updateUI after each message)
    setInterval(() => {
      try { updateUI(); } catch(e){}
      // update countdown
      if (STATE.isRunning) {
        STATE.remainingTime = Math.max(0, (STATE.remainingTime || STATE.intervalMs) - 1000);
        els.countdownText.innerText = `Next in: ${formatTime(STATE.remainingTime)}`;
      }
    }, 1000);

  })();
  </script>

  <!-- SINGLE LIVE BRIDGE: make sure this file exists at repo root and is correct -->
  <script src="live-crypto.js"></script>

</body>
</html>
